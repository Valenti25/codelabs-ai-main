// app/components/TinyStars.tsx
"use client";

import * as React from "react";
import { motion, useAnimation, useReducedMotion } from "framer-motion";

const PATH_SMALL =
  "M41.0002 0C40.8234 0.961028 40.6475 1.89644 40.4718 2.80691C40.2961 3.71761 40.1208 4.60359 39.9446 5.46555C39.7685 6.32773 39.5919 7.16588 39.4139 7.98091C39.236 8.79593 39.0562 9.58806 38.8744 10.358C38.6925 11.1279 38.5084 11.8756 38.3212 12.6017C38.1339 13.3279 37.9437 14.0327 37.7494 14.7172C37.5551 15.4014 37.357 16.0652 37.1541 16.709C36.9512 17.3531 36.7433 17.9773 36.5299 18.5826C36.3166 19.1879 36.0976 19.7744 35.8722 20.3428C35.6469 20.9111 35.415 21.4616 35.176 21.9946C34.9368 22.5276 34.6906 23.0436 34.4363 23.543C34.1819 24.0425 33.9193 24.5256 33.6477 24.9931C33.3761 25.4605 33.0959 25.9124 32.8058 26.3497C32.5156 26.7868 32.2156 27.2092 31.9053 27.6177C31.5947 28.0262 31.2736 28.4207 30.9413 28.8023C30.6087 29.1838 30.2648 29.5522 29.9086 29.9084C29.5525 30.2646 29.184 30.6085 28.8025 30.9411C28.4209 31.2736 28.0265 31.5947 27.6179 31.905C27.2094 32.2156 26.787 32.5153 26.3499 32.8055C25.9128 33.0957 25.461 33.3762 24.9935 33.6475C24.526 33.9189 24.0429 34.1814 23.5435 34.436C23.044 34.6904 22.5283 34.9368 21.995 35.1758C21.4618 35.415 20.9116 35.6467 20.3432 35.872C19.7749 36.0974 19.1884 36.3164 18.583 36.5297C17.9777 36.743 17.3534 36.9507 16.7095 37.1539C16.0654 37.3568 15.4018 37.5551 14.7174 37.7492C14.0332 37.9435 13.3283 38.1337 12.602 38.321C11.8756 38.5082 11.1281 38.6923 10.3582 38.8741C9.58828 39.056 8.79615 39.2355 7.98113 39.4137C7.1661 39.5919 6.32773 39.7685 5.46578 39.9444C4.60359 40.1204 3.7176 40.2958 2.80713 40.4715C1.89643 40.6472 0.961028 40.8229 0 41C0.961028 41.1768 1.89643 41.3528 2.80713 41.5285C3.71782 41.7042 4.60382 41.8796 5.46578 42.0556C6.32773 42.2315 7.1661 42.4083 7.98113 42.5863C8.79638 42.7645 9.58828 42.944 10.3582 43.1259C11.1281 43.3077 11.8758 43.4918 12.602 43.679C13.3281 43.8663 14.033 44.0565 14.7174 44.2508C15.4018 44.4451 16.0654 44.6432 16.7095 44.8461C17.3536 45.0491 17.9777 45.257 18.583 45.4703C19.1884 45.6836 19.7749 45.9026 20.3432 46.128C20.9116 46.3533 21.462 46.5853 21.995 46.8242C22.528 47.0634 23.044 47.3096 23.5435 47.564C24.0429 47.8183 24.526 48.0809 24.9935 48.3525C25.461 48.6238 25.9128 48.9043 26.3499 49.1945C26.787 49.4847 27.2096 49.7846 27.6179 50.095C28.0265 50.4053 28.4209 50.7266 28.8025 51.0589C29.184 51.3915 29.5525 51.7354 29.9086 52.0916C30.2648 52.4478 30.6087 52.8162 30.9413 53.1977C31.2739 53.5793 31.5949 53.9738 31.9053 54.3823C32.2159 54.7908 32.5156 55.2132 32.8058 55.6503C33.0959 56.0874 33.3761 56.5394 33.6477 57.0067C33.9191 57.4742 34.1817 57.9573 34.4363 58.4567C34.6906 58.9562 34.9371 59.472 35.176 60.0052C35.415 60.5382 35.6469 61.0886 35.8722 61.657C36.0976 62.2254 36.3166 62.8119 36.5299 63.4172C36.7433 64.0225 36.9509 64.6469 37.1541 65.2907C37.357 65.9348 37.5553 66.5984 37.7494 67.2828C37.9437 67.967 38.1339 68.6719 38.3212 69.3983C38.5084 70.1244 38.6925 70.8721 38.8744 71.642C39.0562 72.4119 39.2357 73.2041 39.4139 74.0191C39.5921 74.8343 39.7687 75.6725 39.9446 76.5344C40.1206 77.3966 40.2961 78.2826 40.4718 79.1931C40.6475 80.1038 40.8232 81.0392 41.0002 82C41.1771 81.039 41.353 80.1036 41.5287 79.1931C41.7044 78.2826 41.8799 77.3964 42.0558 76.5344C42.2317 75.6725 42.4086 74.8341 42.5865 74.0191C42.7647 73.2041 42.9443 72.4119 43.1261 71.642C43.3079 70.8721 43.492 70.1246 43.6793 69.3983C43.8665 68.6721 44.0567 67.9673 44.251 67.2828C44.4453 66.5986 44.6435 65.9348 44.8464 65.2907C45.0493 64.6466 45.2572 64.0225 45.4705 63.4172C45.6838 62.8119 45.9028 62.2254 46.1282 61.657C46.3535 61.0886 46.5855 60.5382 46.8244 60.0052C47.0634 59.4722 47.3098 58.9562 47.5642 58.4567C47.8185 57.9573 48.0811 57.4742 48.3527 57.0067C48.6241 56.5392 48.9045 56.0874 49.1947 55.6503C49.4849 55.2132 49.7848 54.7908 50.0952 54.3823C50.4058 53.9738 50.7268 53.5793 51.0592 53.1977C51.3917 52.8162 51.7357 52.4478 52.0918 52.0916C52.448 51.7354 52.8164 51.3915 53.1979 51.0589C53.5795 50.7264 53.974 50.4053 54.3825 50.095C54.7911 49.7844 55.2134 49.4847 55.6505 49.1945C56.0876 48.9043 56.5394 48.6241 57.0069 48.3525C57.4744 48.0811 57.9575 47.8186 58.457 47.564C58.9564 47.3096 59.4722 47.0632 60.0054 46.8242C60.5384 46.585 61.0888 46.3533 61.6572 46.128C62.2256 45.9026 62.8121 45.6836 63.4174 45.4703C64.0227 45.257 64.6471 45.0491 65.2909 44.8461C65.935 44.6432 66.5986 44.4449 67.2828 44.2508C67.967 44.0567 68.6719 43.8663 69.3983 43.679C70.1244 43.4918 70.8721 43.3077 71.642 43.1259C72.4119 42.944 73.2041 42.7645 74.0191 42.5863C74.8341 42.4081 75.6723 42.2315 76.5344 42.0556C77.3964 41.8794 78.2824 41.7042 79.1931 41.5285C80.1038 41.3528 81.0392 41.1768 82 41C81.039 40.8232 80.1035 40.6472 79.1931 40.4715C78.2824 40.2958 77.3964 40.1204 76.5344 39.9444C75.6723 39.7685 74.8341 39.5917 74.0191 39.4137C73.2038 39.2355 72.4119 39.0562 71.642 38.8741C70.8721 38.6923 70.1246 38.5082 69.3983 38.321C68.6721 38.1337 67.9673 37.9435 67.2828 37.7492C66.5986 37.5549 65.9348 37.3568 65.2909 37.1539C64.6469 36.9509 64.0227 36.743 63.4174 36.5297C62.8121 36.3164 62.2256 36.0974 61.6572 35.872C61.0888 35.6467 60.5384 35.4147 60.0054 35.1758C59.4724 34.9366 58.9564 34.6904 58.457 34.436C57.9575 34.1817 57.4744 33.9191 57.0069 33.6475C56.5394 33.3762 56.0876 33.0957 55.6505 32.8055C55.2134 32.5153 54.7908 32.2154 54.3825 31.905C53.974 31.5944 53.5795 31.2734 53.1979 30.9411C52.8164 30.6085 52.448 30.2646 52.0918 29.9084C51.7357 29.5522 51.3917 29.1838 51.0592 28.8023C50.7266 28.4207 50.4056 28.0262 50.0952 27.6177C49.7846 27.2092 49.4849 26.7868 49.1947 26.3497C48.9045 25.9126 48.6241 25.4605 48.3527 24.9931C48.0813 24.5256 47.8188 24.0425 47.5642 23.543C47.3098 23.0436 47.0634 22.5278 46.8244 21.9946C46.5853 21.4614 46.3535 20.9111 46.1282 20.3428C45.9028 19.7744 45.6838 19.1879 45.4705 18.5826C45.2572 17.9773 45.0495 17.3529 44.8464 16.709C44.6435 16.065 44.4451 15.4014 44.251 14.7172C44.0567 14.033 43.8663 13.3281 43.6793 12.6017C43.492 11.8756 43.3079 11.1279 43.1261 10.358C42.9443 9.58806 42.7647 8.79616 42.5865 7.98091C42.4083 7.16565 42.2317 6.3275 42.0558 5.46555C41.8799 4.60359 41.7044 3.71761 41.5287 2.80691C41.353 1.89621 41.1771 0.960801 41.0002 0Z";

const PATH_BIG =
  "M83.0004 0.694092C82.6425 2.63959 82.2863 4.53323 81.9306 6.37638C81.575 8.21998 81.2202 10.0136 80.8636 11.7585C80.507 13.5039 80.1495 15.2006 79.7892 16.8506C79.4289 18.5005 79.0649 20.1041 78.6969 21.6627C78.3288 23.2213 77.9561 24.7349 77.577 26.2049C77.1979 27.6749 76.8129 29.1018 76.4195 30.4874C76.0262 31.8725 75.6251 33.2163 75.2143 34.5197C74.8036 35.8236 74.3827 37.0871 73.9508 38.3125C73.519 39.5379 73.0756 40.7252 72.6194 41.8758C72.1632 43.0264 71.6937 44.1407 71.21 45.2197C70.7258 46.2987 70.2274 47.3433 69.7124 48.3544C69.1975 49.3654 68.666 50.3435 68.1162 51.2898C67.5663 52.2362 66.9991 53.1509 66.4117 54.0362C65.8242 54.921 65.217 55.7761 64.5887 56.6031C63.9599 57.4301 63.3101 58.2287 62.6372 59.0011C61.964 59.7735 61.2677 60.5193 60.5467 61.2403C59.8257 61.9614 59.0799 62.6576 58.3075 63.3309C57.5351 64.0041 56.7365 64.654 55.9095 65.2823C55.0824 65.9111 54.2274 66.5178 53.3425 67.1053C52.4577 67.6927 51.543 68.2605 50.5966 68.8098C49.6503 69.3592 48.6722 69.8907 47.6612 70.4061C46.6501 70.921 45.606 71.4199 44.5266 71.9036C43.4471 72.3878 42.3332 72.8569 41.1826 73.3131C40.032 73.7693 38.8447 74.2126 37.6193 74.6445C36.3939 75.0763 35.13 75.4968 33.8265 75.908C32.5227 76.3187 31.1793 76.7203 29.7937 77.1132C28.4086 77.5065 26.9818 77.8916 25.5113 78.2707C24.0408 78.6497 22.5276 79.0224 20.969 79.3905C19.4104 79.7586 17.8068 80.1221 16.1569 80.4828C14.507 80.8435 12.8098 81.2011 11.0649 81.5572C9.31947 81.9134 7.52587 82.2686 5.68272 82.6243C3.83911 82.9799 1.9455 83.3356 0 83.6941C1.9455 84.0521 3.83911 84.4082 5.68272 84.7639C7.52633 85.1196 9.31993 85.4748 11.0649 85.831C12.8098 86.1871 14.507 86.5451 16.1569 86.9054C17.8073 87.2661 19.4104 87.6296 20.969 87.9977C22.5276 88.3658 24.0413 88.7384 25.5113 89.1175C26.9813 89.4966 28.4082 89.8817 29.7937 90.275C31.1793 90.6683 32.5227 91.0694 33.8265 91.4802C35.1304 91.891 36.3939 92.3118 37.6193 92.7437C38.8447 93.1756 40.032 93.6189 41.1826 94.0751C42.3332 94.5313 43.4476 95.0008 44.5266 95.4846C45.6055 95.9687 46.6501 96.4672 47.6612 96.9821C48.6722 97.4971 49.6503 98.0285 50.5966 98.5783C51.543 99.1277 52.4577 99.6954 53.3425 100.283C54.2274 100.87 55.0829 101.478 55.9095 102.106C56.7365 102.734 57.5351 103.384 58.3075 104.057C59.0799 104.731 59.8257 105.427 60.5467 106.148C61.2677 106.869 61.964 107.615 62.6372 108.387C63.3105 109.159 63.9604 109.958 64.5887 110.785C65.2175 111.612 65.8242 112.467 66.4117 113.352C66.9991 114.237 67.5663 115.152 68.1162 116.098C68.6655 117.044 69.197 118.022 69.7124 119.033C70.2274 120.044 70.7263 121.089 71.21 122.168C71.6937 123.247 72.1632 124.361 72.6194 125.512C73.0756 126.662 73.519 127.85 73.9508 129.075C74.3827 130.301 74.8031 131.565 75.2143 132.868C75.6251 134.172 76.0267 135.515 76.4195 136.901C76.8129 138.286 77.1979 139.713 77.577 141.183C77.9561 142.653 78.3288 144.167 78.6969 145.725C79.0649 147.284 79.4284 148.888 79.7892 150.538C80.1499 152.188 80.5074 153.885 80.8636 155.63C81.2197 157.375 81.575 159.169 81.9306 161.012C82.2863 162.855 82.642 164.749 83.0004 166.694C83.3584 164.749 83.7146 162.855 84.0703 161.012C84.426 159.169 84.7812 157.375 85.1373 155.63C85.4935 153.885 85.8515 152.188 86.2117 150.538C86.5725 148.888 86.936 147.284 87.3041 145.725C87.6721 144.167 88.0448 142.654 88.4239 141.183C88.803 139.713 89.188 138.286 89.5813 136.901C89.9746 135.516 90.3758 134.172 90.7865 132.868C91.1973 131.564 91.6182 130.301 92.05 129.075C92.4819 127.85 92.9253 126.662 93.3815 125.512C93.8377 124.361 94.3072 123.247 94.7909 122.168C95.2747 121.089 95.7735 120.044 96.2885 119.033C96.8034 118.022 97.3349 117.044 97.8847 116.098C98.4341 115.152 99.0018 114.237 99.5892 113.352C100.177 112.467 100.784 111.612 101.412 110.785C102.041 109.958 102.691 109.159 103.364 108.387C104.037 107.615 104.733 106.869 105.454 106.148C106.175 105.427 106.921 104.731 107.693 104.057C108.466 103.384 109.264 102.734 110.091 102.106C110.918 101.477 111.773 100.87 112.658 100.283C113.543 99.6954 114.458 99.1282 115.404 98.5783C116.351 98.029 117.329 97.4975 118.34 96.9821C119.351 96.4672 120.395 95.9683 121.474 95.4846C122.553 95.0004 123.668 94.5313 124.818 94.0751C125.969 93.6189 127.156 93.1756 128.382 92.7437C129.607 92.3118 130.871 91.891 132.174 91.4802C133.478 91.0694 134.822 90.6679 136.207 90.275C137.592 89.8821 139.019 89.4966 140.489 89.1175C141.959 88.7384 143.473 88.3658 145.031 87.9977C146.59 87.6296 148.194 87.2661 149.844 86.9054C151.493 86.5446 153.19 86.1871 154.936 85.831C156.681 85.4743 158.474 85.1196 160.318 84.7639C162.161 84.4082 164.055 84.0521 166 83.6941C164.055 83.3361 162.161 82.9799 160.318 82.6243C158.474 82.2686 156.681 81.9134 154.936 81.5572C153.19 81.2011 151.493 80.8431 149.844 80.4828C148.193 80.1221 146.59 79.759 145.031 79.3905C143.473 79.0224 141.96 78.6497 140.489 78.2707C139.019 77.8916 137.592 77.5065 136.207 77.1132C134.822 76.7199 133.478 76.3187 132.174 75.908C130.87 75.4972 129.607 75.0763 128.382 74.6445C127.156 74.2126 125.969 73.7693 124.818 73.3131C123.668 72.8569 122.553 72.3874 121.474 71.9036C120.395 71.4194 119.351 70.921 118.34 70.4061C117.329 69.8911 116.351 69.3597 115.404 68.8098C114.458 68.2605 113.543 67.6927 112.658 67.1053C111.773 66.5178 110.918 65.9106 110.091 65.2823C109.264 64.6536 108.466 64.0037 107.693 63.3309C106.921 62.6576 106.175 61.9614 105.454 61.2403C104.733 60.5193 104.037 59.7735 103.364 59.0011C102.69 58.2287 102.041 57.4301 101.412 56.6031C100.783 55.7761 100.177 54.921 99.5892 54.0362C99.0018 53.1513 98.4341 52.2362 97.8847 51.2898C97.3353 50.3435 96.8039 49.3654 96.2885 48.3544C95.7735 47.3433 95.2747 46.2992 94.7909 45.2197C94.3067 44.1403 93.8377 43.0264 93.3815 41.8758C92.9253 40.7252 92.4819 39.5379 92.05 38.3125C91.6182 37.0871 91.1977 35.8232 90.7865 34.5197C90.3758 33.2158 89.9742 31.8725 89.5813 30.4874C89.188 29.1023 88.8025 27.6754 88.4239 26.2049C88.0448 24.7349 87.6721 23.2213 87.3041 21.6627C86.936 20.1041 86.5725 18.5009 86.2117 16.8506C85.851 15.2002 85.4935 13.5034 85.1373 11.7585C84.7812 10.0136 84.426 8.21998 84.0703 6.37638C83.7146 4.53277 83.3584 2.63913 83.0004 0.694092Z";

function wait(ms: number) {
  return new Promise((r) => setTimeout(r, ms));
}

export default function TinyStars({
  box = { w: 40, h: 80 },
  big = { size: 20, x: 20, y: 42 }, // static star #1
  s1 = { size: 10, x: 25, y: 30 }, // animated star #3 (top)
  s2 = { size: 10, x: 25, y: 45 }, // animated star #2 (bottom)
  speed = 0.35, // up/down duration (sec)
  hold = 0.65,  // hold time per pattern (sec)
  gap = 0.12,   // tiny delay between steps (sec)
}: {
  box?: { w: number; h: number };
  big?: { size: number; x: number; y: number };
  s1?: { size: number; x: number; y: number };
  s2?: { size: number; x: number; y: number };
  speed?: number;
  hold?: number;
  gap?: number;
}) {
  const reduce = useReducedMotion();
  const gidBig = React.useId();
  const gidS1 = React.useId();
  const gidS2 = React.useId();

  const c1 = useAnimation(); // star #3
  const c2 = useAnimation(); // star #2

  // init
  React.useEffect(() => {
    if (reduce) {
      c1.set({ opacity: 1, scale: 1 });
      c2.set({ opacity: 1, scale: 1 });
      return;
    }
    c1.set({ opacity: 0, scale: 0.9 });
    c2.set({ opacity: 0, scale: 0.9 });
  }, [reduce, c1, c2]);

  // loop with "clear all after pattern 2" then "show all"
  React.useEffect(() => {
    if (reduce) return;

    let mounted = true;
    (async () => {
      while (mounted) {
        // Pattern 1: show s1
        await c1.start({
          opacity: [0, 1],
          scale: [0.7, 1],
          transition: { duration: speed, ease: "easeOut" },
        });
        await wait(hold * 1000);

        // Pattern 2: hide s1 -> show s2
        await c1.start({
          opacity: 0,
          scale: 0.9,
          transition: { duration: Math.max(0.2, speed * 0.6), ease: "easeInOut" },
        });
        await wait(gap * 1000);
        await c2.start({
          opacity: [0, 1],
          scale: [0.7, 1],
          transition: { duration: speed, ease: "easeOut" },
        });
        await wait(hold * 1000);

        // *** NEW: Clear all after pattern 2 ***
        await Promise.all([
          c1.start({ opacity: 0, scale: 0.9, transition: { duration: Math.max(0.18, speed * 0.55), ease: "easeInOut" } }),
          c2.start({ opacity: 0, scale: 0.9, transition: { duration: Math.max(0.18, speed * 0.55), ease: "easeInOut" } }),
        ]);
        await wait(Math.max(0, gap * 1000)); // small pause after clear

        // Pattern 3: show ALL stars together (s1 + s2)
        await Promise.all([
          c1.start({ opacity: [0, 1], scale: [0.7, 1], transition: { duration: speed, ease: "easeOut" } }),
          c2.start({ opacity: [0, 1], scale: [0.7, 1], transition: { duration: speed, ease: "easeOut" } }),
        ]);
        await wait(hold * 1000);

        // Reset before the next cycle
        await Promise.all([
          c1.start({ opacity: 0, scale: 0.9, transition: { duration: Math.max(0.2, speed * 0.6), ease: "easeInOut" } }),
          c2.start({ opacity: 0, scale: 0.9, transition: { duration: Math.max(0.2, speed * 0.6), ease: "easeInOut" } }),
        ]);
        await wait(Math.max(0, (gap * 0.7) * 1000));
      }
    })();

    return () => {
      mounted = false;
    };
  }, [reduce, c1, c2, speed, hold, gap]);

  return (
    <div className="relative" style={{ width: box.w, height: box.h }}>
      {/* static big star (#1) */}
      <svg
        width={big.size}
        height={big.size}
        viewBox="0 0 166 167"
        className="absolute"
        style={{ left: big.x, top: big.y, transform: "translate(-50%,-50%)" }}
        fill="none"
        aria-label="star-1-static"
      >
        <path d={PATH_BIG} fill={`url(#${gidBig})`} />
        <defs>
          <linearGradient id={gidBig} x1="41.5" y1="40" x2="127" y2="131" gradientUnits="userSpaceOnUse">
            <stop stopColor="#EDB279" />
            <stop offset="0.5" stopColor="#B542D7" />
            <stop offset="1" stopColor="#4514DC" />
          </linearGradient>
        </defs>
      </svg>

      {/* s1 = star #3 (top) */}
      <motion.svg
        width={s1.size}
        height={s1.size}
        viewBox="0 0 82 82"
        className="absolute"
        style={{ left: s1.x, top: s1.y, transform: "translate(-50%,-50%)" }}
        animate={c1}
        fill="none"
        aria-label="star-3-animated"
      >
        <path d={PATH_SMALL} fill={`url(#${gidS1})`} />
        <defs>
          <linearGradient id={gidS1} x1="20.5" y1="19.4162" x2="62.7349" y2="64.368" gradientUnits="userSpaceOnUse">
            <stop stopColor="#EDB279" />
            <stop offset="0.5" stopColor="#B542D7" />
            <stop offset="1" stopColor="#4514DC" />
          </linearGradient>
        </defs>
      </motion.svg>

      {/* s2 = star #2 (bottom) */}
      <motion.svg
        width={s2.size}
        height={s2.size}
        viewBox="0 0 82 82"
        className="absolute"
        style={{ left: s2.x, top: s2.y, transform: "translate(-50%,-50%)" }}
        animate={c2}
        fill="none"
        aria-label="star-2-animated"
      >
        <path d={PATH_SMALL} fill={`url(#${gidS2})`} />
        <defs>
          <linearGradient id={gidS2} x1="20.5" y1="19.4162" x2="62.7349" y2="64.368" gradientUnits="userSpaceOnUse">
            <stop stopColor="#EDB279" />
            <stop offset="0.5" stopColor="#B542D7" />
            <stop offset="1" stopColor="#4514DC" />
          </linearGradient>
        </defs>
      </motion.svg>
    </div>
  );
}
